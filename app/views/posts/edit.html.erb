<h1>投稿の編集</h1>

<!-- ストリーク情報表示 -->
<% begin %>
  <% streak = @post.current_streak %>
  <% if streak %>
    <% streak_count = @post.streak_count %>
    <div class="streak-info" style="background-color: #f0f8ff; padding: 20px; margin-bottom: 20px; border-radius: 8px; border: 1px solid #ddd;">
      <h3 style="margin-top: 0;">📈 現在の継続状況</h3>
      <div style="display: flex; align-items: center; gap: 15px; margin-bottom: 15px;">
        <div class="streak-status" style="padding: 8px 15px; border-radius: 20px; font-weight: bold; 
             background-color: <%= @post.recorded_on > Date.current ? '#ff9800' : (streak_count > 0 ? '#4caf50' : '#f44336') %>; 
             color: white;">
          <% if @post.recorded_on > Date.current %>
            ⏰ 未来の投稿
          <% elsif streak_count > 0 %>
            🔥 <%= streak_count %>日継続中
          <% else %>
            💔 うっかり
          <% end %>
        </div>
        <div style="font-size: 0.9em; color: #666;">
          開始日: <%= l @post.recorded_on, format: :japanese %>
        </div>
      </div>
    </div>
  <% else %>
    <div style="background-color: #fff3cd; padding: 20px; margin-bottom: 20px; border-radius: 8px; border: 1px solid #ffeaa7;">
      <p>ストリーク情報が見つかりません。この投稿を一度更新すると作成されます。</p>
    </div>
  <% end %>
<% rescue => e %>
  <div style="background-color: #f8d7da; padding: 20px; margin-bottom: 20px; border-radius: 8px; border: 1px solid #f5c6cb;">
    <p>ストリーク情報の取得でエラーが発生しました: <%= e.message %></p>
  </div>
<% end %>

<%= form_with(model: @post, local: true) do |form| %>
  <% if @post.errors.any? %>
    <div id="error_explanation">
      <h2><%= @post.errors.count %>件のエラーがあります。</h2>
      <ul>
        <% @post.errors.full_messages.each do |message| %>
          <li><%= message %></li>
        <% end %>
      </ul>
    </div>
  <% end %>

  <div class="field">
    <%= form.label :post, "投稿" %>
    <%= form.text_area :post %>
  </div>

  <div class="field">
    <%= form.label :reason, "理由" %>
    <%= form.text_area :reason %>
  </div>

  <div class="field">
    <%= form.label :category_id, "カテゴリ" %>
    <%= form.collection_select :category_id, Category.all, :id, :name, prompt: "カテゴリを選択してください" %>
  </div>

  <div class="field">
    <%= form.label :recorded_on, "日付" %>
    <%= form.date_field :recorded_on %>
  </div>

  <!-- うっかりリセットチェックボックス -->
  <% if @post.streak&.current_count > 0 %>
    <div class="field" style="background-color: #ffe6e6; padding: 15px; border-radius: 5px; border: 1px solid #ffcccc; margin: 15px 0;">
      <%= form.check_box :reset_streak, {}, "true", "false" %>
      <%= form.label :reset_streak, "この投稿をうっかりリセットする", style: "color: #d32f2f; font-weight: bold;" %>
      <div style="font-size: 0.85em; color: #666; margin-top: 5px;">
        ※ チェックすると、投稿更新時に継続記録がリセットされ、日付が今日に変更されます
      </div>
    </div>
  <% end %>

  <div class="actions">
    <% if @post.is_draft %>
      <%= form.submit "下書き保存", name: "commit_draft" %>  
      <%= form.submit "投稿", name: "commit_publish" %>
    <% else %>
      <%= form.submit "更新" %>
    <% end %>
  </div>
<% end %>

<%= link_to 'キャンセル', post_path(@post) %>
