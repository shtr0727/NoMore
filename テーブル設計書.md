# NoMoreアプリ テーブル設計書

## 1. usersテーブル（ユーザー）

| カラム名 | データ型 | 制約 | 説明 |
|---------|---------|------|------|
| id | integer | PRIMARY KEY, AUTO_INCREMENT | ユーザーID |
| name | string | NOT NULL | ユーザー名 |
| profile | text | | プロフィール |
| email | string | NOT NULL, UNIQUE | メールアドレス（Devise） |
| encrypted_password | string | NOT NULL | 暗号化パスワード（Devise） |
| reset_password_token | string | UNIQUE | パスワードリセットトークン（Devise） |
| reset_password_sent_at | datetime | | パスワードリセット送信日時（Devise） |
| remember_created_at | datetime | | ログイン状態記憶日時（Devise） |
| created_at | datetime | NOT NULL | 作成日時 |
| updated_at | datetime | NOT NULL | 更新日時 |

**リレーション:**
- プロフィール画像（Active Storage: has_one_attached :profile_image）
- has_many :posts（投稿）
- has_many :comments（コメント）
- has_many :favorites（いいね）
- has_many :streaks（継続記録）
- has_many :active_relationships（フォロー中）
- has_many :passive_relationships（フォロワー）

## 2. categoriesテーブル（カテゴリ）

| カラム名 | データ型 | 制約 | 説明 |
|---------|---------|------|------|
| id | integer | PRIMARY KEY, AUTO_INCREMENT | カテゴリID |
| name | string | NOT NULL | カテゴリ名 |
| created_at | datetime | NOT NULL | 作成日時 |
| updated_at | datetime | NOT NULL | 更新日時 |

**リレーション:**
- has_many :posts（投稿）

## 3. postsテーブル（投稿）

| カラム名 | データ型 | 制約 | 説明 |
|---------|---------|------|------|
| id | integer | PRIMARY KEY, AUTO_INCREMENT | 投稿ID |
| user_id | integer | NOT NULL, FOREIGN KEY | ユーザーID |
| post | text | NOT NULL | 投稿内容 |
| reason | text | NOT NULL | 理由 |
| category_id | integer | NOT NULL, FOREIGN KEY | カテゴリID |
| is_draft | boolean | NOT NULL | 下書きフラグ |
| recorded_on | date | NOT NULL | 記録日 |
| created_at | datetime | NOT NULL | 作成日時 |
| updated_at | datetime | NOT NULL | 更新日時 |

**リレーション:**
- belongs_to :user（ユーザー）
- belongs_to :category（カテゴリ）
- has_many :favorites（いいね）
- has_many :comments（コメント）
- has_one :streak（継続記録）

## 4. streaksテーブル（継続記録）

| カラム名 | データ型 | 制約 | 説明 |
|---------|---------|------|------|
| id | integer | PRIMARY KEY, AUTO_INCREMENT | 継続記録ID |
| user_id | integer | NOT NULL, FOREIGN KEY | ユーザーID |
| post_id | integer | NOT NULL, FOREIGN KEY | 投稿ID |
| created_at | datetime | NOT NULL | 作成日時 |
| updated_at | datetime | NOT NULL | 更新日時 |

**リレーション:**
- belongs_to :user（ユーザー）
- belongs_to :post（投稿）

**特徴:**
- 継続日数は`post.recorded_on`から動的計算
- アクティブ状態も動的判定
- 基準日は`post.recorded_on`を使用（dateカラムは削除済み）

## 5. favoritesテーブル（いいね）

| カラム名 | データ型 | 制約 | 説明 |
|---------|---------|------|------|
| id | integer | PRIMARY KEY, AUTO_INCREMENT | いいねID |
| user_id | integer | NOT NULL, FOREIGN KEY | ユーザーID |
| post_id | integer | NOT NULL, FOREIGN KEY | 投稿ID |
| created_at | datetime | NOT NULL | 作成日時 |
| updated_at | datetime | NOT NULL | 更新日時 |

**リレーション:**
- belongs_to :user（ユーザー）
- belongs_to :post（投稿）

## 6. commentsテーブル（コメント）

| カラム名 | データ型 | 制約 | 説明 |
|---------|---------|------|------|
| id | integer | PRIMARY KEY, AUTO_INCREMENT | コメントID |
| user_id | integer | NOT NULL, FOREIGN KEY | ユーザーID |
| post_id | integer | NOT NULL, FOREIGN KEY | 投稿ID |
| content | text | NOT NULL | コメント内容 |
| created_at | datetime | NOT NULL | 作成日時 |
| updated_at | datetime | NOT NULL | 更新日時 |

**リレーション:**
- belongs_to :user（ユーザー）
- belongs_to :post（投稿）

**バリデーション:**
- content: 最大500文字

## 7. relationshipsテーブル（フォロー関係）

| カラム名 | データ型 | 制約 | 説明 |
|---------|---------|------|------|
| id | integer | PRIMARY KEY, AUTO_INCREMENT | 関係ID |
| follower_id | integer | NOT NULL, FOREIGN KEY | フォローするユーザーID |
| followed_id | integer | NOT NULL, FOREIGN KEY | フォローされるユーザーID |
| created_at | datetime | NOT NULL | 作成日時 |
| updated_at | datetime | NOT NULL | 更新日時 |

**リレーション:**
- belongs_to :follower（フォローするユーザー）
- belongs_to :followed（フォローされるユーザー）

**バリデーション:**
- follower_id + followed_idの組み合わせは一意

## 8. badgesテーブル（バッジ）

| カラム名 | データ型 | 制約 | 説明 |
|---------|---------|------|------|
| id | integer | PRIMARY KEY, AUTO_INCREMENT | バッジID |
| name | string | NOT NULL, UNIQUE | バッジ名 |
| description | string | NOT NULL | バッジ説明 |
| badge_type | string | | バッジ種類（streak/achievement/special） |
| required_days | integer | | 必要継続日数（継続日数バッジ用） |
| created_at | datetime | NOT NULL | 作成日時 |
| updated_at | datetime | NOT NULL | 更新日時 |

**特徴:**
- ユーザーの獲得バッジは動的計算（継続日数に基づく）
- post_badgesテーブルは削除済み

## 9. Active Storageテーブル群（ファイルアップロード）

### active_storage_attachments
| カラム名 | データ型 | 制約 | 説明 |
|---------|---------|------|------|
| id | integer | PRIMARY KEY, AUTO_INCREMENT | 添付ID |
| name | string | NOT NULL | 添付名 |
| record_type | string | NOT NULL | レコード型 |
| record_id | bigint | NOT NULL | レコードID |
| blob_id | bigint | NOT NULL, FOREIGN KEY | BlobID |
| created_at | datetime | NOT NULL | 作成日時 |

### active_storage_blobs
| カラム名 | データ型 | 制約 | 説明 |
|---------|---------|------|------|
| id | integer | PRIMARY KEY, AUTO_INCREMENT | BlobID |
| key | string | NOT NULL, UNIQUE | ファイルキー |
| filename | string | NOT NULL | ファイル名 |
| content_type | string | | コンテンツタイプ |
| metadata | text | | メタデータ |
| service_name | string | NOT NULL | サービス名 |
| byte_size | bigint | NOT NULL | ファイルサイズ |
| checksum | string | | チェックサム |
| created_at | datetime | NOT NULL | 作成日時 |

### active_storage_variant_records
| カラム名 | データ型 | 制約 | 説明 |
|---------|---------|------|------|
| id | integer | PRIMARY KEY, AUTO_INCREMENT | バリアントID |
| blob_id | bigint | NOT NULL, FOREIGN KEY | BlobID |
| variation_digest | string | NOT NULL | バリエーション |

## ER図の関係性

```
User ||--o{ Post : has_many
User ||--o{ Comment : has_many
User ||--o{ Favorite : has_many
User ||--o{ Streak : has_many
User ||--o{ Relationship (follower) : has_many
User ||--o{ Relationship (followed) : has_many
User ||--|| ProfileImage (Active Storage) : has_one_attached

Category ||--o{ Post : has_many

Post ||--o{ Comment : has_many
Post ||--o{ Favorite : has_many
Post ||--|| Streak : has_one
Post }o--|| User : belongs_to
Post }o--|| Category : belongs_to

Comment }o--|| User : belongs_to
Comment }o--|| Post : belongs_to

Favorite }o--|| User : belongs_to
Favorite }o--|| Post : belongs_to

Streak }o--|| User : belongs_to
Streak }o--|| Post : belongs_to

Relationship }o--|| User (follower) : belongs_to
Relationship }o--|| User (followed) : belongs_to

Badge (動的計算によりユーザーの獲得バッジを決定)
```

## 主な変更点（初期設計からの変更）

1. **post_badgesテーブルの削除**: バッジは継続日数に基づく動的計算に変更
2. **streaksテーブルの簡素化**: ステータス管理を動的計算に変更
3. **postsテーブルの調整**: `recorded_on`をdate型に変更、`streak_id`を削除
4. **Active Storageの追加**: プロフィール画像アップロード機能
5. **relationshipsテーブルの追加**: ユーザー間のフォロー機能
6. **継続日数の計算ロジック変更**: `post.recorded_on`を基準とした動的計算

## 備考

- SQLiteを使用（開発環境）
- Deviseを使用した認証機能
- Active Storageを使用したファイルアップロード機能
- 継続日数とバッジは動的計算により実現
